{% extends 'study/base.html' %}

{% block title %}Study Session - {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
    .flashcard-container {
        perspective: 1000px;
        margin: 2rem auto;
        max-width: 600px;
    }
    
    .flashcard {
        position: relative;
        width: 100%;
        min-height: 300px;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        cursor: pointer;
    }
    
    .flashcard.flipped {
        transform: rotateY(180deg);
    }
    
    .flashcard-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        min-height: 300px;
    }
    
    .flashcard-front {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .flashcard-back {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        transform: rotateY(180deg);
    }
    
    .progress-bar {
        background: #e9ecef;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .progress-fill {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        transition: width 0.3s;
    }
    
    .diagram-container, .code-container, .graph-container {
        margin-top: 1rem;
        text-align: left;
    }
    
    .code-container pre {
        background: rgba(0, 0, 0, 0.1);
        padding: 1rem;
        border-radius: 5px;
        overflow-x: auto;
        text-align: left;
    }
    
    .graph-container img {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div>
    <div style="margin-bottom: 2rem;">
        <a href="{% url 'topic_detail' topic.id %}" style="color: #667eea; text-decoration: none;">
            ‚Üê End Session
        </a>
    </div>
    
    <h1 style="text-align: center; color: #667eea; margin-bottom: 1rem;">
        Study Session: {{ topic.name }}
    </h1>
    
    <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
    </div>
    
    <div style="text-align: center; margin-bottom: 1rem;">
        <span id="cardCounter">0</span> of {{ flashcards|length }} cards
    </div>
    
    <div class="flashcard-container">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
            <div class="flashcard-face flashcard-front">
                <div style="text-align: center; width: 100%;">
                    <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Question</h2>
                    <div id="questionImage" style="margin-bottom: 1rem;"></div>
                    <div id="question" style="font-size: 1.2rem;"></div>
                    <div id="question-diagram" class="diagram-container"></div>
                    <div id="question-code" class="code-container"></div>
                    <div id="question-graph" class="graph-container"></div>
                    <p style="margin-top: 2rem; opacity: 0.8; font-size: 0.9rem;">
                        Click to reveal answer
                    </p>
                </div>
            </div>
            <div class="flashcard-face flashcard-back">
                <div style="text-align: center; width: 100%;">
                    <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Answer</h2>
                    <div id="answerImage" style="margin-bottom: 1rem;"></div>
                    <div id="answer" style="font-size: 1.2rem;"></div>
                    <div id="answer-diagram" class="diagram-container"></div>
                    <div id="answer-code" class="code-container"></div>
                    <div id="answer-graph" class="graph-container"></div>
>>>>>>> main
                </div>
            </div>
        </div>
    </div>
    
    <div id="hint" style="display: none; text-align: center; margin: 1rem auto; max-width: 600px; padding: 1rem; background: #fff3cd; border-radius: 10px;">
        <strong>Hint:</strong> <span id="hintText"></span>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
        <button onclick="showHint()" class="btn btn-secondary" id="hintBtn">Show Hint</button>
        <button onclick="markCorrect()" class="btn" style="background: #28a745;">‚úì Got it!</button>
        <button onclick="markIncorrect()" class="btn btn-danger">‚úó Missed</button>
        <button onclick="nextCard()" class="btn btn-secondary">Skip</button>
        <a href="#" onclick="submitFeedback(); return false;" class="btn btn-secondary" id="feedbackBtn">üí¨ Feedback</a>
    </div>
    
    <form id="endSessionForm" method="post" action="{% url 'end_study_session' session.id %}" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="cards_studied" id="cardsStudied" value="0">
    </form>
</div>

<script>
    const cards = {{ flashcards_json|safe }};
    let currentIndex = 0;
    let cardsStudied = 0;
    let isFlipped = false;
    
    function loadCard() {
        if (currentIndex >= cards.length) {
            endSession();
            return;
        }
        
        const card = cards[currentIndex];
        
        // Load text content
        document.getElementById('question').innerHTML = card.question;
        document.getElementById('answer').innerHTML = card.answer;
        document.getElementById('cardCounter').textContent = currentIndex + 1;
        document.getElementById('hintText').textContent = card.hint;
        
        // Clear previous rich media
        document.getElementById('question-diagram').innerHTML = '';
        document.getElementById('answer-diagram').innerHTML = '';
        document.getElementById('question-code').innerHTML = '';
        document.getElementById('answer-code').innerHTML = '';
        document.getElementById('question-graph').innerHTML = '';
        document.getElementById('answer-graph').innerHTML = '';
        
        // Load images
        const questionImg = document.getElementById('questionImage');
        const answerImg = document.getElementById('answerImage');
        
        // Clear previous images
        questionImg.innerHTML = '';
        answerImg.innerHTML = '';
        
        if (card.question_image_url) {
            const img = document.createElement('img');
            img.src = card.question_image_url;
            img.alt = 'Question image';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '200px';
            img.style.borderRadius = '5px';
            questionImg.appendChild(img);
        }
        
        if (card.answer_image_url) {
            const img = document.createElement('img');
            img.src = card.answer_image_url;
            img.alt = 'Answer image';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '200px';
            img.style.borderRadius = '5px';
            answerImg.appendChild(img);
        }
        
        // Render diagrams if present
        if (card.diagram_code) {
            const diagramDiv = document.createElement('div');
            diagramDiv.className = 'mermaid';
            diagramDiv.textContent = card.diagram_code;
            document.getElementById('question-diagram').appendChild(diagramDiv);
        }
        
        // Render code snippets if present
        if (card.code_snippet && card.code_language) {
            const preElement = document.createElement('pre');
            const codeElement = document.createElement('code');
            codeElement.className = `language-${card.code_language}`;
            codeElement.textContent = card.code_snippet;
            preElement.appendChild(codeElement);
            document.getElementById('question-code').appendChild(preElement);
            if (typeof Prism !== 'undefined') {
                Prism.highlightElement(codeElement);
            }
        }
        
        // Render graph if present
        if (card.graph_image_url) {
            const imgElement = document.createElement('img');
            imgElement.src = card.graph_image_url;
            imgElement.alt = 'Graph';
            document.getElementById('question-graph').appendChild(imgElement);
        }
        
        // Trigger MathJax to re-render if present
        if (card.uses_latex && typeof MathJax !== 'undefined') {
            MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
        }
        
        // Trigger Mermaid to re-render diagrams
        if (card.diagram_code && typeof mermaid !== 'undefined') {
            mermaid.init(undefined, '.mermaid');
        }
        
        // Update feedback button
        const feedbackBtn = document.getElementById('feedbackBtn');
        feedbackBtn.href = '/flashcard/' + card.id + '/feedback/';
>>>>>>> main
        
        if (card.hint) {
            document.getElementById('hintBtn').style.display = 'inline-block';
        } else {
            document.getElementById('hintBtn').style.display = 'none';
        }
        
        document.getElementById('hint').style.display = 'none';
        
        const progress = ((currentIndex) / cards.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        
        if (isFlipped) {
            flipCard();
        }
    }
    
    function submitFeedback() {
        const card = cards[currentIndex];
        window.location.href = '/flashcard/' + card.id + '/feedback/';
    }
    
    function flipCard() {
        const flashcard = document.getElementById('flashcard');
        flashcard.classList.toggle('flipped');
        isFlipped = !isFlipped;
    }
    
    function showHint() {
        document.getElementById('hint').style.display = 'block';
    }
    
    function markCorrect() {
        if (!isFlipped) {
            alert('Please reveal the answer first!');
            return;
        }
        cardsStudied++;
        nextCard();
    }
    
    function markIncorrect() {
        if (!isFlipped) {
            alert('Please reveal the answer first!');
            return;
        }
        cardsStudied++;
        nextCard();
    }
    
    function nextCard() {
        currentIndex++;
        loadCard();
    }
    
    function endSession() {
        document.getElementById('cardsStudied').value = cardsStudied;
        document.getElementById('endSessionForm').submit();
    }
    
    // Load first card
    loadCard();
</script>
{% endblock %}
