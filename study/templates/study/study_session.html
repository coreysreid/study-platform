{% extends 'study/base.html' %}

{% block title %}Study Session - {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
    .flashcard-container {
        perspective: 1000px;
        margin: 2rem auto;
        max-width: 600px;
    }
    
    .flashcard {
        position: relative;
        width: 100%;
        min-height: 300px;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        cursor: pointer;
    }
    
    .flashcard.flipped {
        transform: rotateY(180deg);
    }
    
    .flashcard-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        min-height: 300px;
    }
    
    .flashcard-front {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .flashcard-back {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        transform: rotateY(180deg);
    }
    
    .progress-bar {
        background: #e9ecef;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .progress-fill {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        transition: width 0.3s;
    }
    
    .diagram-container, .code-container, .graph-container {
        margin-top: 1rem;
        text-align: left;
    }
    
    .code-container pre {
        background: rgba(0, 0, 0, 0.1);
        padding: 1rem;
        border-radius: 5px;
        overflow-x: auto;
        text-align: left;
    }
    
    .graph-container img {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
    }
    
    /* Study Mode Selector */
    .study-mode-bar {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    
    .study-mode-bar .mode-btn {
        padding: 0.4rem 1rem;
        border-radius: 20px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
        transition: all 0.3s;
    }
    
    .study-mode-bar .mode-btn:hover {
        background: #667eea;
        color: white;
    }
    
    .study-mode-bar .mode-btn.active {
        background: #667eea;
        color: white;
    }
    
    /* Visual mode: larger cards, emphasis on images/diagrams */
    .mode-visual .flashcard-face {
        min-height: 400px;
        font-size: 1.1rem;
    }
    .mode-visual .graph-container img,
    .mode-visual .diagram-container {
        transform: scale(1.1);
        margin: 1.5rem auto;
    }
    
    /* Text-heavy mode: more compact, text-focused */
    .mode-text_heavy .flashcard-face {
        min-height: 250px;
        padding: 1.5rem;
    }
    .mode-text_heavy .graph-container,
    .mode-text_heavy .diagram-container {
        display: none;
    }
    .mode-text_heavy #question,
    .mode-text_heavy #answer {
        font-size: 1.3rem;
        line-height: 1.8;
    }
    
    /* Challenge mode: timer bar, no hints */
    .mode-challenge .flashcard-front {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    .mode-challenge .flashcard-back {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }
    
    .timer-bar {
        display: none;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    .timer-fill {
        height: 100%;
        background: #e74c3c;
        transition: width 0.1s linear;
        width: 100%;
    }
    .mode-challenge .timer-bar {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
{% if nudge_topics %}
<div style="background:#fff8e1;border:1px solid #ffe082;border-radius:10px;padding:1.25rem;margin-bottom:1.5rem;max-width:640px;margin-left:auto;margin-right:auto;">
    <strong>Heads up</strong>
    <p style="margin:0.5rem 0;">Your recent scores on <em>{{ topic.name }}</em> suggest some prerequisite topics may need reinforcement.</p>
    <ul style="margin:0.5rem 0 0.75rem;padding-left:1.25rem;">
    {% for item in nudge_topics %}
        <li>
            <a href="{% url 'study_session' item.topic.id %}">{{ item.topic.name }}</a>
            {% if item.score_pct is not None %}(score: {{ item.score_pct }}%){% else %}(no recent activity){% endif %}
        </li>
    {% endfor %}
    </ul>
    <a href="?" class="btn btn-secondary" style="font-size:0.85rem;padding:0.3rem 0.75rem;">Dismiss</a>
</div>
{% endif %}
<div>
    <div style="margin-bottom: 2rem;">
        <a href="{% url 'topic_detail' topic.id %}" style="color: #667eea; text-decoration: none;">
            ‚Üê End Session
        </a>
    </div>
    
    <h1 style="text-align: center; color: #667eea; margin-bottom: 1rem;">
        Study Session: {% if topic.code %}<span class="topic-code">{{ topic.code }}</span> ¬∑ {% endif %}{{ topic.name }}
    </h1>
    
    <!-- Study Mode Selector -->
    <div class="study-mode-bar">
        {% for mode_key, mode_label in study_modes %}
        <a href="?mode={{ mode_key }}" class="mode-btn {% if study_mode == mode_key %}active{% endif %}">
            {% if mode_key == 'standard' %}üìñ{% elif mode_key == 'visual' %}üé®{% elif mode_key == 'text_heavy' %}üìù{% elif mode_key == 'challenge' %}‚ö°{% endif %}
            {{ mode_label }}
        </a>
        {% endfor %}
    </div>
    
    <div class="timer-bar">
        <div class="timer-fill" id="timerBar"></div>
    </div>
    
    <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
    </div>
    
    <div style="text-align: center; margin-bottom: 1rem;">
        <span id="cardCounter">0</span> of <span id="cardTotal"></span> cards
    </div>
    
    <div class="flashcard-container" id="flashcard-container">
        <div class="flashcard" id="flashcard">
            <div class="flashcard-face flashcard-front">
                <div style="text-align: center; width: 100%;">
                    <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Question</h2>
                    <div id="questionImage" style="margin-bottom: 1rem;"></div>
                    <div id="question" style="font-size: 1.2rem;"></div>
                    <div id="question-diagram" class="diagram-container"></div>
                    <div id="question-code" class="code-container"></div>
                    <div id="question-graph" class="graph-container"></div>
                    <p style="margin-top: 2rem; opacity: 0.8; font-size: 0.9rem;">
                        Click to reveal answer
                    </p>
                </div>
            </div>
            <div class="flashcard-face flashcard-back">
                <div style="text-align: center; width: 100%;">
                    <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Answer</h2>
                    <div id="answerImage" style="margin-bottom: 1rem;"></div>
                    <div id="answer" style="font-size: 1.2rem;"></div>
                    <div id="answer-diagram" class="diagram-container"></div>
                    <div id="answer-code" class="code-container"></div>
                    <div id="answer-graph" class="graph-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step card display (shown instead of flip card for step_by_step) -->
    <div id="stepCardContainer" style="display:none; max-width: 640px; margin: 0 auto;">
        <div style="background: #f8f9fa; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
            <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 0.5rem;" id="stepCounter"></div>
            <strong>Problem:</strong>
            <div id="stepQuestion" style="font-size: 1.1rem; margin: 0.5rem 0 1rem;"></div>
            <div id="priorStepsContainer" style="border-top: 1px solid #dee2e6; padding-top: 0.75rem;"></div>
            <div id="nextStepPrompt" style="margin-top: 0.75rem; color: #495057; font-style: italic;">
                What is the next move?
            </div>
        </div>
        <div id="stepReveal" style="display:none; background: #e8f5e9; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
            <strong>Step:</strong> <span id="stepMove" style="font-size: 1.1rem;"></span>
            <div id="stepDetail" style="margin-top: 0.5rem; font-size: 0.95rem; color: #555;"></div>
        </div>
    </div>

    <!-- Teacher explanation panel (hidden until requested) -->
    <div id="teacherPanel" style="display:none; max-width: 640px; margin: 1rem auto; background: #fff8e1; border-radius: 12px; padding: 1.5rem;">
        <strong>Teacher Explanation</strong>
        <div id="teacherText" style="margin-top: 0.75rem; line-height: 1.6;"></div>
    </div>
    
    <div id="hint" style="display: none; text-align: center; margin: 1rem auto; max-width: 600px; padding: 1rem; background: #fff3cd; border-radius: 10px;">
        <strong>Hint:</strong> <span id="hintText"></span>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
        <button onclick="markResult(true)" class="btn" style="background: #28a745;" id="gotItBtn">Got it</button>
        <button onclick="markResult(null)" class="btn btn-secondary" id="nearlyBtn">Nearly</button>
        <button onclick="markResult(false)" class="btn btn-danger" id="missedBtn">Missed it</button>
        <button onclick="nextCard()" class="btn btn-secondary">Skip</button>
    </div>
    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 0.5rem; flex-wrap: wrap;">
        <button onclick="showHint()" class="btn btn-secondary" id="hintBtn">Show Hint</button>
        <button onclick="toggleTeacherExplanation()" class="btn btn-secondary" id="teacherBtn" style="display:none;">Full Explanation</button>
        <button onclick="submitFeedback()" class="btn btn-secondary" id="feedbackBtn">Feedback</button>
    </div>
    
    <form id="endSessionForm" method="post" action="{% url 'end_study_session' session.id %}" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="cards_studied" id="cardsStudied" value="0">
    </form>
</div>

{{ flashcards_data|json_script:"flashcards-data" }}
<script>
    const cards = JSON.parse(document.getElementById('flashcards-data').textContent);
    const studyMode = '{{ study_mode }}';
    const csrfToken = '{{ csrf_token }}';

    // Set total card count (uses expanded virtual cards count)
    document.getElementById('cardTotal').textContent = cards.length;

    let currentIndex = 0;
    let cardsStudied = 0;
    let isFlipped = false;
    let isStepCard = false;
    let timerInterval = null;

    document.querySelector('.content').classList.add('mode-' + studyMode);
    const FLIP_DURATION = 650;
    const CHALLENGE_SECONDS = 30;

    function startTimer() {
        if (studyMode !== 'challenge') return;
        let timeLeft = CHALLENGE_SECONDS;
        const bar = document.getElementById('timerBar');
        bar.style.width = '100%';
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(function() {
            timeLeft -= 0.1;
            bar.style.width = Math.max(0, (timeLeft / CHALLENGE_SECONDS) * 100) + '%';
            if (timeLeft <= 0) { clearInterval(timerInterval); if (!isFlipped) revealCard(); }
        }, 100);
    }

    function stopTimer() {
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    }

    function loadCard() {
        if (currentIndex >= cards.length) { endSession(); return; }

        const card = cards[currentIndex];
        isStepCard = (card.question_type === 'step_by_step');
        isFlipped = false;

        document.getElementById('teacherPanel').style.display = 'none';
        document.getElementById('teacherBtn').style.display = 'none';
        document.getElementById('hint').style.display = 'none';
        document.getElementById('stepReveal').style.display = 'none';
        document.getElementById('nextStepPrompt').style.display = '';
        document.getElementById('feedbackBtn').dataset.cardId = card.id;
        document.getElementById('feedbackBtn').dataset.cardQuestion = card.question;

        if (card.teacher_explanation) {
            document.getElementById('teacherText').textContent = card.teacher_explanation;
        }

        if (isStepCard) {
            loadStepCard(card);
        } else {
            loadFlipCard(card);
        }

        document.getElementById('cardCounter').textContent = currentIndex + 1;
        document.getElementById('progressBar').style.width =
            ((currentIndex / cards.length) * 100) + '%';
        startTimer();
    }

    function loadFlipCard(card) {
        document.getElementById('flashcard-container').style.display = '';
        document.getElementById('stepCardContainer').style.display = 'none';

        const fc = document.getElementById('flashcard');
        if (fc.classList.contains('flipped')) fc.classList.remove('flipped');

        document.getElementById('question').textContent = card.question;
        document.getElementById('answer').textContent = card.answer;

        setImage('questionImage', card.question_image);
        setImage('answerImage', card.answer_image);
        setImage('question-graph', card.graph_image_url);
        document.getElementById('answer-graph').textContent = '';

        const qDiag = document.getElementById('question-diagram');
        qDiag.textContent = '';
        if (card.diagram_code) {
            const mermaidDiv = document.createElement('div');
            mermaidDiv.className = 'mermaid';
            mermaidDiv.textContent = card.diagram_code;
            qDiag.appendChild(mermaidDiv);
        }
        document.getElementById('answer-diagram').textContent = '';
        document.getElementById('question-code').textContent = '';
        document.getElementById('answer-code').textContent = '';

        if (studyMode !== 'challenge' && card.hint) {
            document.getElementById('hintBtn').style.display = 'inline-block';
            document.getElementById('hintText').textContent = card.hint;
        } else {
            document.getElementById('hintBtn').style.display = 'none';
        }

        if (typeof MathJax !== 'undefined') MathJax.typesetPromise();
        if (card.diagram_code && typeof mermaid !== 'undefined') mermaid.init(undefined, '.mermaid');
    }

    function loadStepCard(card) {
        document.getElementById('flashcard-container').style.display = 'none';
        document.getElementById('stepCardContainer').style.display = '';
        document.getElementById('hintBtn').style.display = 'none';

        document.getElementById('stepCounter').textContent =
            'Step ' + (card.step_index + 1) + ' of ' + card.step_total;
        document.getElementById('stepQuestion').textContent = card.question;

        const priorContainer = document.getElementById('priorStepsContainer');
        priorContainer.textContent = '';
        if (card.context_steps && card.context_steps.length > 0) {
            card.context_steps.forEach(function(s, i) {
                const div = document.createElement('div');
                div.style.cssText = 'margin-bottom: 0.4rem; color: #495057;';
                div.textContent = 'Step ' + (i + 1) + ': ' + s.move;
                priorContainer.appendChild(div);
            });
        }

        if (typeof MathJax !== 'undefined') MathJax.typesetPromise();
    }

    function setImage(containerId, url) {
        const el = document.getElementById(containerId);
        el.textContent = '';
        if (url) {
            const img = document.createElement('img');
            img.src = url;
            img.style.cssText = 'max-width:100%; max-height:200px;';
            el.appendChild(img);
        }
    }

    function revealCard() {
        stopTimer();
        if (isStepCard) {
            const card = cards[currentIndex];
            document.getElementById('stepMove').textContent = card.answer;
            document.getElementById('stepDetail').textContent = card.answer_detail || '';
            document.getElementById('stepReveal').style.display = '';
            document.getElementById('nextStepPrompt').style.display = 'none';
            if (card.teacher_explanation) {
                document.getElementById('teacherBtn').style.display = 'inline-block';
            }
            if (typeof MathJax !== 'undefined') MathJax.typesetPromise();
        } else {
            document.getElementById('flashcard').classList.add('flipped');
            const card = cards[currentIndex];
            if (card.teacher_explanation) {
                document.getElementById('teacherBtn').style.display = 'inline-block';
            }
        }
        isFlipped = true;
    }

    document.getElementById('flashcard').onclick = function() {
        if (!isFlipped) revealCard();
    };

    function toggleTeacherExplanation() {
        const panel = document.getElementById('teacherPanel');
        panel.style.display = (panel.style.display === 'none') ? '' : 'none';
    }

    function showHint() {
        document.getElementById('hint').style.display = 'block';
    }

    function postProgress(cardId, stepIndex, correct) {
        const url = '/flashcard/' + cardId + '/progress/';
        const body = new URLSearchParams({
            csrfmiddlewaretoken: csrfToken,
            correct: correct ? 'true' : 'false',
            step_index: stepIndex,
        });
        fetch(url, { method: 'POST', body: body }).catch(function() {});
    }

    function markResult(correct) {
        if (!isFlipped) { revealCard(); return; }
        const card = cards[currentIndex];
        postProgress(card.id, card.step_index, correct === true);
        cardsStudied++;
        moveToNext();
    }

    function moveToNext() {
        stopTimer();
        currentIndex++;
        if (isStepCard) {
            loadCard();
        } else {
            if (isFlipped) {
                document.getElementById('flashcard').classList.remove('flipped');
                setTimeout(loadCard, FLIP_DURATION);
            } else {
                loadCard();
            }
        }
    }

    function nextCard() {
        moveToNext();
    }

    function submitFeedback() {
        const btn = document.getElementById('feedbackBtn');
        const question = (btn.dataset.cardQuestion || '').substring(0, 60);
        const cardId = btn.dataset.cardId || '';
        if (typeof openFeedbackModal === 'function') {
            document.getElementById('feedbackTitle').value = 'Flashcard Feedback: ' + question;
            document.getElementById('feedbackType').value = 'content';
            document.getElementById('feedbackDescription').value =
                'Flashcard ID: ' + cardId + '\n\nPlease describe the issue:\n';
            openFeedbackModal();
        }
    }

    function endSession() {
        stopTimer();
        document.getElementById('cardsStudied').value = cardsStudied;
        document.getElementById('endSessionForm').submit();
    }

    loadCard();
</script>
{% endblock %}
