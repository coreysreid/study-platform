{% extends 'study/base.html' %}

{% block title %}Study Session - {{ topic.name }}{% endblock %}

{% block extra_css %}
<style>
    .flashcard-container {
        perspective: 1000px;
        margin: 2rem auto;
        max-width: 600px;
    }
    
    .flashcard {
        position: relative;
        width: 100%;
        min-height: 300px;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        cursor: pointer;
    }
    
    .flashcard.flipped {
        transform: rotateY(180deg);
    }
    
    .flashcard-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        min-height: 300px;
    }
    
    .flashcard-front {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .flashcard-back {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        transform: rotateY(180deg);
    }
    
    .progress-bar {
        background: #e9ecef;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .progress-fill {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        transition: width 0.3s;
    }
    
    .diagram-container, .code-container, .graph-container {
        margin-top: 1rem;
        text-align: left;
    }
    
    .code-container pre {
        background: rgba(0, 0, 0, 0.1);
        padding: 1rem;
        border-radius: 5px;
        overflow-x: auto;
        text-align: left;
    }
    
    .graph-container img {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
    }
    
    /* Study Mode Selector */
    .study-mode-bar {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    
    .study-mode-bar .mode-btn {
        padding: 0.4rem 1rem;
        border-radius: 20px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
        transition: all 0.3s;
    }
    
    .study-mode-bar .mode-btn:hover {
        background: #667eea;
        color: white;
    }
    
    .study-mode-bar .mode-btn.active {
        background: #667eea;
        color: white;
    }
    
    /* Visual mode: larger cards, emphasis on images/diagrams */
    .mode-visual .flashcard-face {
        min-height: 400px;
        font-size: 1.1rem;
    }
    .mode-visual .graph-container img,
    .mode-visual .diagram-container {
        transform: scale(1.1);
        margin: 1.5rem auto;
    }
    
    /* Text-heavy mode: more compact, text-focused */
    .mode-text_heavy .flashcard-face {
        min-height: 250px;
        padding: 1.5rem;
    }
    .mode-text_heavy .graph-container,
    .mode-text_heavy .diagram-container {
        display: none;
    }
    .mode-text_heavy #question,
    .mode-text_heavy #answer {
        font-size: 1.3rem;
        line-height: 1.8;
    }
    
    /* Challenge mode: timer bar, no hints */
    .mode-challenge .flashcard-front {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    .mode-challenge .flashcard-back {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }
    
    .timer-bar {
        display: none;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    .timer-fill {
        height: 100%;
        background: #e74c3c;
        transition: width 0.1s linear;
        width: 100%;
    }
    .mode-challenge .timer-bar {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div>
    <div style="margin-bottom: 2rem;">
        <a href="{% url 'topic_detail' topic.id %}" style="color: #667eea; text-decoration: none;">
            ‚Üê End Session
        </a>
    </div>
    
    <h1 style="text-align: center; color: #667eea; margin-bottom: 1rem;">
        Study Session: {{ topic.name }}
    </h1>
    
    <!-- Study Mode Selector -->
    <div class="study-mode-bar">
        {% for mode_key, mode_label in study_modes %}
        <a href="?mode={{ mode_key }}" class="mode-btn {% if study_mode == mode_key %}active{% endif %}">
            {% if mode_key == 'standard' %}üìñ{% elif mode_key == 'visual' %}üé®{% elif mode_key == 'text_heavy' %}üìù{% elif mode_key == 'challenge' %}‚ö°{% endif %}
            {{ mode_label }}
        </a>
        {% endfor %}
    </div>
    
    <div class="timer-bar">
        <div class="timer-fill" id="timerBar"></div>
    </div>
    
    <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
    </div>
    
    <div style="text-align: center; margin-bottom: 1rem;">
        <span id="cardCounter">0</span> of <span id="cardTotal"></span> cards
    </div>
    
    <div class="flashcard-container">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
            <div class="flashcard-face flashcard-front">
                <div style="text-align: center; width: 100%;">
                    <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Question</h2>
                    <div id="questionImage" style="margin-bottom: 1rem;"></div>
                    <div id="question" style="font-size: 1.2rem;"></div>
                    <div id="question-diagram" class="diagram-container"></div>
                    <div id="question-code" class="code-container"></div>
                    <div id="question-graph" class="graph-container"></div>
                    <p style="margin-top: 2rem; opacity: 0.8; font-size: 0.9rem;">
                        Click to reveal answer
                    </p>
                </div>
            </div>
            <div class="flashcard-face flashcard-back">
                <div style="text-align: center; width: 100%;">
                    <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Answer</h2>
                    <div id="answerImage" style="margin-bottom: 1rem;"></div>
                    <div id="answer" style="font-size: 1.2rem;"></div>
                    <div id="answer-diagram" class="diagram-container"></div>
                    <div id="answer-code" class="code-container"></div>
                    <div id="answer-graph" class="graph-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="hint" style="display: none; text-align: center; margin: 1rem auto; max-width: 600px; padding: 1rem; background: #fff3cd; border-radius: 10px;">
        <strong>Hint:</strong> <span id="hintText"></span>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
        <button onclick="showHint()" class="btn btn-secondary" id="hintBtn">Show Hint</button>
        <button onclick="markCorrect()" class="btn" style="background: #28a745;">‚úì Got it!</button>
        <button onclick="markIncorrect()" class="btn btn-danger">‚úó Missed</button>
        <button onclick="nextCard()" class="btn btn-secondary">Skip</button>
        <button onclick="submitFeedback()" class="btn btn-secondary" id="feedbackBtn">üí¨ Feedback</button>
    </div>
    
    <form id="endSessionForm" method="post" action="{% url 'end_study_session' session.id %}" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="cards_studied" id="cardsStudied" value="0">
    </form>
</div>

{{ flashcards_data|json_script:"flashcards-data" }}
<script>
    const cards = JSON.parse(document.getElementById('flashcards-data').textContent);
    document.getElementById('cardTotal').textContent = cards.length;
    const studyMode = '{{ study_mode }}';
    let currentIndex = 0;
    let cardsStudied = 0;
    let isFlipped = false;
    let timerInterval = null;
    
    // Apply study mode class to container
    document.querySelector('.content').classList.add('mode-' + studyMode);
    
    // Animation duration constant (matches CSS transition: transform 0.6s)
    const FLIP_ANIMATION_DURATION = 650; // 650ms to ensure animation completes (600ms + buffer)
    
    // Challenge mode: timer duration in seconds
    const CHALLENGE_TIMER_SECONDS = 30;
    
    function startTimer() {
        if (studyMode !== 'challenge') return;
        
        let timeLeft = CHALLENGE_TIMER_SECONDS;
        const timerBar = document.getElementById('timerBar');
        timerBar.style.width = '100%';
        
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(function() {
            timeLeft -= 0.1;
            const pct = (timeLeft / CHALLENGE_TIMER_SECONDS) * 100;
            timerBar.style.width = Math.max(0, pct) + '%';
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                // Auto-flip to reveal answer when time runs out
                if (!isFlipped) {
                    flipCard();
                }
            }
        }, 100);
    }
    
    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }
    
    function loadCard() {
        if (currentIndex >= cards.length) {
            endSession();
            return;
        }
        
        const card = cards[currentIndex];
        
        // Load text content
        // Always use textContent for security - MathJax can typeset from text nodes
        document.getElementById('question').textContent = card.question;
        document.getElementById('answer').textContent = card.answer;
        document.getElementById('cardCounter').textContent = currentIndex + 1;
        document.getElementById('hintText').textContent = card.hint;
        
        // Clear previous rich media
        document.getElementById('question-diagram').innerHTML = '';
        document.getElementById('answer-diagram').innerHTML = '';
        document.getElementById('question-code').innerHTML = '';
        document.getElementById('answer-code').innerHTML = '';
        document.getElementById('question-graph').innerHTML = '';
        document.getElementById('answer-graph').innerHTML = '';
        
        // Load images
        const questionImg = document.getElementById('questionImage');
        const answerImg = document.getElementById('answerImage');
        
        // Clear previous images
        questionImg.innerHTML = '';
        answerImg.innerHTML = '';
        
        if (card.question_image_url) {
            const img = document.createElement('img');
            img.src = card.question_image_url;
            img.alt = 'Question image';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '200px';
            img.style.borderRadius = '5px';
            questionImg.appendChild(img);
        }
        
        if (card.answer_image_url) {
            const img = document.createElement('img');
            img.src = card.answer_image_url;
            img.alt = 'Answer image';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '200px';
            img.style.borderRadius = '5px';
            answerImg.appendChild(img);
        }
        
        // Render diagrams if present
        if (card.diagram_code) {
            const diagramDiv = document.createElement('div');
            diagramDiv.className = 'mermaid';
            diagramDiv.textContent = card.diagram_code;
            document.getElementById('question-diagram').appendChild(diagramDiv);
        }
        
        // Render code snippets if present
        if (card.code_snippet && card.code_language) {
            const preElement = document.createElement('pre');
            const codeElement = document.createElement('code');
            codeElement.className = `language-${card.code_language}`;
            codeElement.textContent = card.code_snippet;
            preElement.appendChild(codeElement);
            document.getElementById('question-code').appendChild(preElement);
            if (typeof Prism !== 'undefined') {
                Prism.highlightElement(codeElement);
            }
        }
        
        // Render graph if present
        if (card.graph_image_url) {
            const imgElement = document.createElement('img');
            imgElement.src = card.graph_image_url;
            imgElement.alt = 'Graph';
            document.getElementById('question-graph').appendChild(imgElement);
        }
        
        // Trigger MathJax to re-render if present
        if (card.uses_latex && typeof MathJax !== 'undefined') {
            MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
        }
        
        // Trigger Mermaid to re-render diagrams
        if (card.diagram_code && typeof mermaid !== 'undefined') {
            mermaid.init(undefined, '.mermaid');
        }
        
        // Store current card id on the button for feedback context
        document.getElementById('feedbackBtn').dataset.cardId = card.id;
        document.getElementById('feedbackBtn').dataset.cardQuestion = card.question;
        
        // In challenge mode, hide hints
        if (studyMode === 'challenge') {
            document.getElementById('hintBtn').style.display = 'none';
        } else if (card.hint) {
            document.getElementById('hintBtn').style.display = 'inline-block';
        } else {
            document.getElementById('hintBtn').style.display = 'none';
        }
        
        document.getElementById('hint').style.display = 'none';
        
        const progress = ((currentIndex) / cards.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        
        // Start timer for challenge mode
        startTimer();
    }
    
    function submitFeedback() {
        const btn = document.getElementById('feedbackBtn');
        const question = (btn.dataset.cardQuestion || '').substring(0, 60);
        const cardId = btn.dataset.cardId || '';
        if (typeof openFeedbackModal === 'function') {
            document.getElementById('feedbackTitle').value = 'Flashcard Feedback: ' + question;
            document.getElementById('feedbackType').value = 'content';
            document.getElementById('feedbackDescription').value = 'Flashcard ID: ' + cardId + '\n\nPlease describe the issue with this flashcard:\n';
            openFeedbackModal();
        }
    }
    
    function flipCard() {
        const flashcard = document.getElementById('flashcard');
        flashcard.classList.toggle('flipped');
        isFlipped = !isFlipped;
        if (isFlipped) {
            stopTimer();
        }
    }
    
    function showHint() {
        document.getElementById('hint').style.display = 'block';
    }
    
    function markCorrect() {
        if (!isFlipped) {
            alert('Please reveal the answer first!');
            return;
        }
        cardsStudied++;
        nextCard();
    }
    
    function markIncorrect() {
        if (!isFlipped) {
            alert('Please reveal the answer first!');
            return;
        }
        cardsStudied++;
        nextCard();
    }
    
    function nextCard() {
        stopTimer();
        currentIndex++;
        // If card is flipped (showing answer), flip it back first
        if (isFlipped) {
            flipCard(); // Flip card back to question side
            // Wait for flip animation to complete before loading new content
            setTimeout(() => {
                loadCard();
            }, FLIP_ANIMATION_DURATION);
        } else {
            // Card not flipped, load immediately
            loadCard();
        }
    }
    
    function endSession() {
        stopTimer();
        document.getElementById('cardsStudied').value = cardsStudied;
        document.getElementById('endSessionForm').submit();
    }
    
    // Load first card
    loadCard();
</script>
{% endblock %}
